name: Build and Sync to COS

on:
  push:
    tags:
      - "v*"
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      skip_sync:
        description: "Skip COS sync (for testing builds only)"
        required: false
        default: "false"
        type: boolean
      force_release:
        description: "Force create release (ignore commit message check)"
        required: false
        default: "false"
        type: boolean

env:
  APP_NAME: SuperKeyHUB
  PYTHON_VERSION: "3.11"
  UV_VERSION: "0.4.0"

jobs:
  # Ê£ÄÊµãÊòØÂê¶ÈúÄË¶ÅÂàõÂª∫ release
  check-release:
    name: Check Release Trigger
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.check.outputs.should_release }}
      app_version: ${{ steps.check.outputs.app_version }}
      is_tag: ${{ steps.check.outputs.is_tag }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check release conditions
        id: check
        run: |
          # Ê£ÄÊü•ÊòØÂê¶ÊòØ tag Ëß¶Âèë
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "üìå Triggered by tag: ${{ github.ref_name }}"
            echo "should_release=true" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            # ‰ªé tag ÂêçÁß∞ÊèêÂèñÁâàÊú¨Âè∑ÔºàÂéªÊéâ v ÂâçÁºÄÔºâ
            TAG_VERSION="${{ github.ref_name }}"
            echo "app_version=${TAG_VERSION#v}" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "is_tag=false" >> $GITHUB_OUTPUT
          
          # Ê£ÄÊü•ÊòØÂê¶ÊâãÂä®Ëß¶ÂèëÂπ∂Âº∫Âà∂ÂèëÂ∏É
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.force_release }}" == "true" ]]; then
            echo "üöÄ Force release triggered manually"
            FORCE_RELEASE=true
          else
            FORCE_RELEASE=false
          fi
          
          # Ê£ÄÊü• commit message ÊòØÂê¶ÂåÖÂê´ releaseÔºà‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜôÔºâ
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "üìù Commit message: $COMMIT_MSG"
          
          if echo "$COMMIT_MSG" | grep -iq "release" || [[ "$FORCE_RELEASE" == "true" ]]; then
            echo "‚úÖ Release keyword found or force release enabled"
            
            # ‰ªé main.py ÊèêÂèñ APP_VERSION
            APP_VERSION=$(grep -oP 'APP_VERSION:\s*str\s*=\s*"\K[^"]+' main.py)
            
            if [[ -z "$APP_VERSION" ]]; then
              echo "‚ùå Could not extract APP_VERSION from main.py"
              exit 1
            fi
            
            echo "üì¶ Detected APP_VERSION: $APP_VERSION"
            
            # Ê£ÄÊü•ËØ•ÁâàÊú¨ÁöÑ tag ÊòØÂê¶Â∑≤Â≠òÂú®
            if git rev-parse "v$APP_VERSION" >/dev/null 2>&1; then
              echo "‚ö†Ô∏è Tag v$APP_VERSION already exists, skipping release"
              echo "should_release=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Tag v$APP_VERSION does not exist, will create release"
              echo "should_release=true" >> $GITHUB_OUTPUT
              echo "app_version=$APP_VERSION" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ÑπÔ∏è No release keyword in commit message, skipping release"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

  build-windows:
    name: Build Windows
    needs: check-release
    runs-on: windows-latest
    outputs:
      app_version: ${{ steps.version.outputs.app_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: ${{ env.UV_VERSION }}

      - name: Download sftool
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # ‰ªé OpenSiFli/sftool releases ‰∏ãËΩΩÊúÄÊñ∞ÁöÑ Windows ÁâàÊú¨
          $SFTOOL_REPO = "OpenSiFli/sftool"
          
          Write-Host "Fetching latest sftool release..."
          
          # ‰ΩøÁî® GitHub API Ëé∑ÂèñÊúÄÊñ∞ release ‰∏≠ÂåπÈÖçÁöÑËµÑÊ∫ê
          $releases = gh api "repos/$SFTOOL_REPO/releases/latest" | ConvertFrom-Json
          $asset = $releases.assets | Where-Object { $_.name -like "*x86_64-pc-windows-msvc.zip" } | Select-Object -First 1
          
          if (-not $asset) {
              Write-Error "‚ùå No matching sftool asset found for x86_64-pc-windows-msvc"
              exit 1
          }
          
          $downloadUrl = $asset.browser_download_url
          $fileName = $asset.name
          
          Write-Host "Downloading: $fileName"
          Write-Host "URL: $downloadUrl"
          
          # ‰∏ãËΩΩÊñá‰ª∂
          Invoke-WebRequest -Uri $downloadUrl -OutFile $fileName
          
          # Ëß£ÂéãÂà∞Â∑•‰ΩúÁõÆÂΩï
          Write-Host "Extracting to working directory..."
          Expand-Archive -Path $fileName -DestinationPath "." -Force
          
          # È™åËØÅ sftool.exe Â≠òÂú®
          if (Test-Path "sftool.exe") {
              Write-Host "‚úÖ sftool.exe downloaded successfully"
              Get-Item "sftool.exe" | Select-Object Name, Length
          } else {
              Write-Error "‚ùå sftool.exe not found after extraction"
              Get-ChildItem "."
              exit 1
          }
          
          # Ê∏ÖÁêÜÂéãÁº©ÂåÖ
          Remove-Item $fileName -Force

      - name: Install dependencies
        shell: pwsh
        run: |
          # Windows Âπ≥Âè∞ÂÆâË£ÖÊâÄÊúâ‰æùËµñÔºàÂåÖÊã¨ windows extras Âíå dev ‰æùËµñÁªÑÔºâ
          uv sync --extra windows
          # ÂçïÁã¨ÂÆâË£Ö dev ‰æùËµñÁªÑ‰∏≠ÁöÑÊûÑÂª∫Â∑•ÂÖ∑
          uv pip install ruff mypy pyinstaller

      - name: Run lint check
        run: |
          uv run ruff check . --select=E,F
        continue-on-error: true

      - name: Extract version and create version JSON
        id: version
        shell: pwsh
        run: |
          # ‰ªé main.py ÊèêÂèñ APP_VERSION
          $versionMatch = Select-String -Path "main.py" -Pattern 'APP_VERSION:\s*str\s*=\s*"([^"]+)"'
          if ($versionMatch) {
              $appVersion = $versionMatch.Matches.Groups[1].Value
              Write-Host "‚úÖ Detected APP_VERSION: $appVersion"
          } else {
              Write-Error "‚ùå Could not find APP_VERSION in main.py"
              exit 1
          }
          
          # ‰ªé main.py ÊèêÂèñ FIRMWARE_COMPATÔºàÂèØÈÄâÔºâ
          $firmwareMatch = Select-String -Path "main.py" -Pattern 'FIRMWARE_COMPAT:\s*str\s*=\s*"([^"]+)"'
          $firmwareCompat = ""
          if ($firmwareMatch) {
              $firmwareCompat = $firmwareMatch.Matches.Groups[1].Value
              Write-Host "‚úÖ Detected FIRMWARE_COMPAT: $firmwareCompat"
          }
          
          # Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥Êà≥
          $buildTime = Get-Date -Format "yyyy-MM-ddTHH:mm:ssZ"
          
          # ÂàõÂª∫ÁâàÊú¨ JSON Êñá‰ª∂
          $versionInfo = @{
              version = $appVersion
              firmware_compat = $firmwareCompat
              build_time = $buildTime
              tag = "v$appVersion"
              commit = "${{ github.sha }}"
              download_url = "https://github.com/${{ github.repository }}/releases/download/v$appVersion/"
          }
          
          $jsonContent = $versionInfo | ConvertTo-Json -Depth 10
          $jsonContent | Out-File -FilePath "hub_verid.json" -Encoding UTF8
          
          Write-Host "‚úÖ Created hub_verid.json:"
          Get-Content "hub_verid.json"
          
          # ËÆæÁΩÆËæìÂá∫ÂèòÈáè‰æõÂêéÁª≠Ê≠•È™§‰ΩøÁî®
          echo "app_version=$appVersion" >> $env:GITHUB_OUTPUT

      - name: Build with PyInstaller
        run: |
          uv run python build.py --no-installer
          
      - name: Copy sftool.exe to dist
        shell: pwsh
        run: |
          # Â∞Ü sftool.exe Â§çÂà∂Âà∞ÊûÑÂª∫ËæìÂá∫ÁõÆÂΩï
          if (Test-Path "sftool.exe") {
              Copy-Item "sftool.exe" -Destination "dist\${{ env.APP_NAME }}\" -Force
              Write-Host "‚úÖ sftool.exe copied to dist folder"
          } else {
              Write-Warning "‚ö†Ô∏è sftool.exe not found in working directory"
          }

      - name: Verify build output
        shell: pwsh
        run: |
          if (Test-Path "dist\${{ env.APP_NAME }}\${{ env.APP_NAME }}.exe") {
              Write-Host "‚úÖ Build successful"
              Get-ChildItem "dist\${{ env.APP_NAME }}" | Select-Object Name, Length
          } else {
              Write-Error "‚ùå Build failed - exe not found"
              exit 1
          }
          
          # È™åËØÅ sftool.exe Âú®ÊûÑÂª∫ËæìÂá∫‰∏≠
          if (Test-Path "dist\${{ env.APP_NAME }}\sftool.exe") {
              Write-Host "‚úÖ sftool.exe included in build"
          } else {
              Write-Error "‚ùå sftool.exe not found in build output"
              exit 1
          }

      - name: Install NSIS
        run: |
          choco install nsis -y

      - name: Build NSIS Installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

      - name: Verify installer
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.app_version }}"
          $installerPath = "dist\${{ env.APP_NAME }}-${version}-Setup.exe"
          
          if (Test-Path $installerPath) {
              Write-Host "‚úÖ Installer created: $installerPath"
              Get-Item $installerPath | Select-Object Name, Length
          } else {
              Write-Warning "‚ö†Ô∏è Installer not found at expected path"
              Get-ChildItem "dist" -Filter "*.exe"
          }

      - name: Create portable ZIP
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.app_version }}"
          $zipName = "${{ env.APP_NAME }}-${version}-Windows-Portable.zip"
          
          Compress-Archive -Path "dist\${{ env.APP_NAME }}\*" -DestinationPath "dist\$zipName"
          Write-Host "‚úÖ Portable ZIP created: dist\$zipName"

      - name: Copy version JSON to dist
        shell: pwsh
        run: |
          # Â∞ÜÁâàÊú¨ JSON Êñá‰ª∂Â§çÂà∂Âà∞ dist ÁõÆÂΩï
          Copy-Item "hub_verid.json" -Destination "dist\" -Force
          Write-Host "‚úÖ hub_verid.json copied to dist folder"
          Get-Content "dist\hub_verid.json"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: |
            dist/*.exe
            dist/*.zip
            dist/hub_verid.json
          retention-days: 7

  sync-to-cos:
    name: Sync to Tencent COS
    needs: [check-release, build-windows]
    runs-on: ubuntu-latest
    if: |
      needs.check-release.outputs.should_release == 'true' &&
      (github.event_name != 'workflow_dispatch' || github.event.inputs.skip_sync != 'true')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          echo "üì¶ Downloaded artifacts:"
          find artifacts -type f -exec ls -lh {} \;

      - name: Upload to COS
        uses: OpenSiFli/SiFliMirrorSync@v1
        with:
          secret_id: ${{ secrets.COS_SECRET_ID }}
          secret_key: ${{ secrets.COS_SECRET_KEY }}
          region: ${{ secrets.COS_REGION }}
          bucket: ${{ secrets.COS_BUCKET }}
          prefix: github_assets/${{ github.repository }}/releases/download/v${{ needs.check-release.outputs.app_version }}/
          artifacts: artifacts/
          delete_remote: true
          flush_url: ${{ secrets.COS_CDN_URL }}github_assets/${{ github.repository }}/releases/download/v${{ needs.check-release.outputs.app_version }}/

  create-release:
    name: Create Tag and GitHub Release
    needs: [check-release, build-windows, sync-to-cos]
    runs-on: ubuntu-latest
    if: needs.check-release.outputs.should_release == 'true'
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Create tag if not exists
        if: needs.check-release.outputs.is_tag != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="v${{ needs.check-release.outputs.app_version }}"
          
          # Ê£ÄÊü• tag ÊòØÂê¶Â∑≤Â≠òÂú®
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Tag $TAG_NAME already exists"
          else
            echo "üè∑Ô∏è Creating tag: $TAG_NAME"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "‚úÖ Tag $TAG_NAME created and pushed"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.check-release.outputs.app_version }}
          name: Release v${{ needs.check-release.outputs.app_version }}
          files: artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(needs.check-release.outputs.app_version, '-alpha') || contains(needs.check-release.outputs.app_version, '-beta') || contains(needs.check-release.outputs.app_version, '-rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
