# SuperKeyHUB CI/CD Pipeline

name: SuperKeyHUB CI

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint:
    name: Code Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Lint Tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pyflakes

      - name: Syntax Check (pyflakes)
        run: |
          pyflakes *.py || true

      - name: Code Style Check (flake8)
        run: |
          flake8 *.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 *.py --count --exit-zero --max-complexity=15 --max-line-length=120 --ignore=E501,F401,E402,F403,F405 --statistics

  test-dependencies:
    name: Dependency Test (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip Dependencies
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Core Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama pystray Pillow

      - name: Install Optional Dependencies
        run: |
          pip install wmi pythonnet pynvml
        continue-on-error: true

      - name: Verify Imports
        run: |
          python -c "import flet; print(f'Flet version: {flet.version.version}')"
          python -c "import psutil; print(f'psutil version: {psutil.__version__}')"
          python -c "import serial; print('pyserial OK')"
          python -c "import requests; print(f'requests version: {requests.__version__}')"
          python -c "import pystray; print('pystray OK')"
          python -c "from PIL import Image; print('Pillow OK')"

      - name: Verify Optional Modules
        run: |
          python -c "import wmi; print('WMI OK')" || echo "WMI not available"
          python -c "import clr; print('pythonnet OK')" || echo "pythonnet not available"

  test-modules:
    name: Module Test
    runs-on: windows-latest
    needs: test-dependencies
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip Dependencies
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama pystray Pillow wmi pythonnet pynvml
        continue-on-error: true

      - name: Test config_manager Module
        run: |
          python -c "
          from config_manager import get_config_manager, ConfigManager
          cm = get_config_manager()
          print('config_manager module loaded successfully')
          print(f'Config path: {cm.get_config_path()}')
          print(f'Weather config: {cm.get_weather_config()}')
          print(f'Auto connect: {cm.should_auto_connect()}')
          print(f'Minimize to tray: {cm.should_minimize_to_tray()}')
          "

      - name: Test system_tray Module
        run: |
          python -c "
          from system_tray import SystemTray, AutoStartManager, is_tray_available
          print('system_tray module loaded successfully')
          print(f'Tray available: {is_tray_available()}')
          print(f'AutoStart supported: {AutoStartManager.is_supported()}')
          print(f'AutoStart enabled: {AutoStartManager.is_enabled()}')
          "

      - name: Test custom_key_manager Module
        run: |
          python -c "
          from custom_key_manager import (
              get_custom_key_manager, PRESET_SHORTCUTS,
              get_all_key_options, get_modifier_options,
              KEY_NAME_MAP, Modifier, KeyCode
          )
          print('custom_key_manager module loaded successfully')
          print(f'Preset shortcuts count: {len(PRESET_SHORTCUTS)}')
          print(f'Key options count: {len(get_all_key_options())}')
          print(f'Modifier options count: {len(get_modifier_options())}')
          mgr = get_custom_key_manager()
          print(f'Key 0 display: {mgr.get_key_display_text(0)}')
          "

      - name: Test weather_api Module
        run: |
          python -c "
          from weather_api import QWeatherAPI
          api = QWeatherAPI()
          print('weather_api module loaded successfully')
          print(f'Default city: {api.default_city}')
          print(f'Predefined cities count: {len(api.predefined_cities)}')
          config = api.get_config()
          print(f'API configured: {config.get(\"api_configured\", False)}')
          "

      - name: Test serial_assistant Module
        run: |
          python -c "
          from serial_assistant import SerialAssistant, DataFormat
          print('serial_assistant module loaded successfully')
          print(f'DataFormat options: {[e.name for e in DataFormat]}')
          sa = SerialAssistant()
          ports = sa.list_ports()
          print(f'Available ports: {len(ports)}')
          "

      - name: Test finsh_data_sender Module
        run: |
          python -c "
          from finsh_data_sender import FinshDataSender
          print('finsh_data_sender module loaded successfully')
          "

      - name: Test hw_monitor Module
        run: |
          python -c "
          from hw_monitor import HardwareMonitor, bytes2human, pct_str, mhz_str, temp_str, watt_str
          print('hw_monitor module loaded successfully')
          print(f'bytes2human test: {bytes2human(1073741824)} = 1.0 GB')
          print(f'pct_str test: {pct_str(75.5)}')
          print(f'mhz_str test: {mhz_str(3500)}')
          print(f'temp_str test: {temp_str(65.5)}')
          print(f'watt_str test: {watt_str(125.5)}')
          "

  build:
    name: Build Windows EXE
    runs-on: windows-latest
    needs: [lint, test-modules]
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip Dependencies
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-build-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-build-
            ${{ runner.os }}-pip-

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama pystray Pillow
          pip install wmi pythonnet pynvml
          pip install pyinstaller>=5.13.0

      - name: Download LibreHardwareMonitor DLL
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "libs" | Out-Null
          
          Write-Host "Fetching latest release info..."
          $headers = @{ "User-Agent" = "GitHub-Actions" }
          
          try {
            $release = Invoke-RestMethod -Uri "https://api.github.com/repos/LibreHardwareMonitor/LibreHardwareMonitor/releases/latest" -Headers $headers
            $version = $release.tag_name
            Write-Host "Latest version: $version"
            
            $asset = $release.assets | Where-Object { $_.name -match "net4" -and $_.name -match "\.zip$" } | Select-Object -First 1
            
            if (-not $asset) {
              $asset = $release.assets | Where-Object { $_.name -match "\.zip$" -and $_.name -notmatch "source" } | Select-Object -First 1
            }
            
            if ($asset) {
              Write-Host "Downloading: $($asset.name)"
              Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "lhm.zip" -Headers $headers
              
              Write-Host "Extracting..."
              Expand-Archive -Path "lhm.zip" -DestinationPath "lhm_temp" -Force
              
              $dll = Get-ChildItem -Path "lhm_temp" -Recurse -Filter "LibreHardwareMonitorLib.dll" | Select-Object -First 1
              if ($dll) {
                Copy-Item -Path $dll.FullName -Destination "libs/LibreHardwareMonitorLib.dll" -Force
                Write-Host "DLL extracted successfully to libs/"
              } else {
                Write-Host "ERROR: DLL not found in archive"
                exit 1
              }
              
              Remove-Item -Path "lhm.zip" -Force -ErrorAction SilentlyContinue
              Remove-Item -Path "lhm_temp" -Recurse -Force -ErrorAction SilentlyContinue
            } else {
              Write-Host "ERROR: No suitable asset found"
              exit 1
            }
          } catch {
            Write-Host "ERROR: Failed to download - $_"
            exit 1
          }

      - name: Verify Resource Files
        shell: powershell
        run: |
          if (Test-Path "libs/LibreHardwareMonitorLib.dll") {
            $size = (Get-Item "libs/LibreHardwareMonitorLib.dll").Length / 1KB
            Write-Host "LibreHardwareMonitorLib.dll exists ($([math]::Round($size, 1)) KB)"
          } else {
            Write-Host "LibreHardwareMonitorLib.dll missing"
            exit 1
          }
          
          if (Test-Path "assets/logo_484x74.png") {
            Write-Host "Logo file exists"
          } else {
            Write-Host "Logo file missing (optional)"
          }
          
          if (Test-Path "assets/app.ico") {
            Write-Host "App icon exists"
          } else {
            Write-Host "App icon missing (optional)"
          }

      - name: Build Executable
        run: |
          python build.py
        env:
          PYTHONUTF8: 1
          PYTHONIOENCODING: utf-8

      - name: Verify Build Artifacts
        shell: powershell
        run: |
          if (Test-Path "dist/SuperKeyHUB.exe") {
            $size = (Get-Item "dist/SuperKeyHUB.exe").Length / 1MB
            Write-Host "SuperKeyHUB.exe built successfully ($([math]::Round($size, 1)) MB)"
          } else {
            Write-Host "Build failed - exe not found"
            exit 1
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SuperKeyHUB-Windows-x64
          path: dist/SuperKeyHUB.exe
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: SuperKeyHUB-Windows-x64
          path: release/

      - name: Get Version
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: SuperKeyHUB ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## SuperKeyHUB ${{ steps.get_version.outputs.VERSION }}
            
            ### ä¸‹è½½ / Download
            - `SuperKeyHUB.exe` - Windows å¯æ‰§è¡Œæ–‡ä»¶
            
            ### åŠŸèƒ½ç‰¹æ€§
            - ğŸ–¥ï¸ å®æ—¶ç¡¬ä»¶ç›‘æ§ï¼ˆCPU/GPU/å†…å­˜/ç£ç›˜/ç½‘ç»œï¼‰
            - ğŸŒ¤ï¸ å¤©æ°”ä¿¡æ¯æ˜¾ç¤ºï¼ˆå’Œé£å¤©æ°”APIï¼‰
            - âŒ¨ï¸ è‡ªå®šä¹‰å¿«æ·é”®é…ç½®
            - ğŸ”Œ ä¸²å£é€šä¿¡ï¼ˆæ”¯æŒè‡ªåŠ¨é‡è¿ï¼‰
            - ğŸ“¤ Finsh æ•°æ®å‘é€
            - ğŸ–±ï¸ ç³»ç»Ÿæ‰˜ç›˜æ”¯æŒï¼ˆæœ€å°åŒ–åå°è¿è¡Œï¼‰
            - ğŸš€ å¼€æœºè‡ªå¯åŠ¨ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
            
            ### ä½¿ç”¨æ–¹æ³•
            1. é€šè¿‡ USB è¿æ¥ SuperKey è®¾å¤‡
            2. è¿è¡Œ SuperKeyHUB.exe
            3. åœ¨ä¸²å£é…ç½®é¡µé¢é€‰æ‹©æ­£ç¡®çš„ COM ç«¯å£
            4. è®¾ç½®æ³¢ç‰¹ç‡ä¸º 1000000
            5. ç‚¹å‡»è¿æ¥ï¼Œç„¶åå¯ç”¨æ•°æ®å‘é€
            
            ### ç³»ç»Ÿè¦æ±‚
            - Windows 10/11
            - .NET Framework 4.7.2+
            
            ### å‘½ä»¤è¡Œå‚æ•°
            - `--minimized` æˆ– `-m`ï¼šå¯åŠ¨æ—¶æœ€å°åŒ–åˆ°ç³»ç»Ÿæ‰˜ç›˜
            
            ### é…ç½®æ–‡ä»¶ä½ç½®
            - `%APPDATA%\SuperKey\superkey_config.json`
            - `%APPDATA%\SuperKey\custom_keys.json`
            
            ### æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡è¿è¡Œéœ€è¦ç®¡ç†å‘˜æƒé™ï¼ˆç”¨äºç¡¬ä»¶ç›‘æ§ï¼‰
            - å¼€æœºè‡ªå¯åŠ¨ä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼Œè‡ªåŠ¨ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
          files: |
            release/SuperKeyHUB.exe
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
