# SuperKeyHUB CI/CD Pipeline
# 自动化测试、语法检查和 Windows 构建

name: SuperKeyHUB CI

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # 代码质量检查 (跨平台)
  # ============================================
  lint:
    name: 代码检查
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 安装检查工具
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pyflakes

      - name: 语法检查 (pyflakes)
        run: |
          # 仅检查语法错误，忽略导入问题（因为有些是 Windows 专用模块）
          pyflakes *.py || true

      - name: 代码风格检查 (flake8)
        run: |
          # E501: 行太长 (忽略)
          # F401: 导入未使用 (忽略，部分是条件导入)
          # E402: 模块级导入不在顶部 (忽略)
          # F403/F405: 通配符导入 (忽略)
          flake8 *.py --count --select=E9,F63,F7,F82 --show-source --statistics || true
          flake8 *.py --count --exit-zero --max-complexity=15 --max-line-length=120 --ignore=E501,F401,E402,F403,F405 --statistics

  # ============================================
  # 依赖安装测试 (Windows)
  # ============================================
  test-dependencies:
    name: 依赖测试 (Windows)
    runs-on: windows-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 安装核心依赖
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama

      - name: 安装可选依赖
        run: |
          pip install wmi pythonnet pynvml
        continue-on-error: true

      - name: 验证导入
        run: |
          python -c "import flet; print(f'Flet version: {flet.version.version}')"
          python -c "import psutil; print(f'psutil version: {psutil.__version__}')"
          python -c "import serial; print('pyserial OK')"
          python -c "import requests; print(f'requests version: {requests.__version__}')"

      - name: 验证可选模块
        run: |
          python -c "import wmi; print('WMI OK')" || echo "WMI not available"
          python -c "import clr; print('pythonnet OK')" || echo "pythonnet not available"

  # ============================================
  # 模块测试 (Windows)
  # ============================================
  test-modules:
    name: 模块测试
    runs-on: windows-latest
    needs: test-dependencies
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama wmi pythonnet pynvml
        continue-on-error: true

      - name: 测试 weather_api 模块
        run: |
          python -c "
          from weather_api import QWeatherAPI
          api = QWeatherAPI()
          print('weather_api module loaded successfully')
          print(f'Supported weather codes: {len(api.weather_conditions)} types')
          "

      - name: 测试 stock_api 模块
        run: |
          python -c "
          from stock_api import StockAPI
          api = StockAPI()
          indexes = api.get_supported_indexes()
          print('stock_api module loaded successfully')
          print(f'Supported indexes: {list(indexes.values())}')
          "

      - name: 测试 serial_assistant 模块
        run: |
          python -c "
          from serial_assistant import SerialAssistant, DataFormat
          print('serial_assistant module loaded successfully')
          print(f'DataFormat options: {[e.name for e in DataFormat]}')
          "

      - name: 测试 finsh_data_sender 模块
        run: |
          python -c "
          from finsh_data_sender import FinshDataSender
          print('finsh_data_sender module loaded successfully')
          "

      - name: 测试 hw_monitor 模块
        run: |
          python -c "
          from hw_monitor import HardwareMonitor, bytes2human, pct_str
          print('hw_monitor module loaded successfully')
          print(f'bytes2human test: {bytes2human(1073741824)} = 1.0 GB')
          print(f'pct_str test: {pct_str(75.5)}')
          "

  # ============================================
  # 构建 Windows 可执行文件
  # ============================================
  build:
    name: 构建 Windows EXE
    runs-on: windows-latest
    needs: [lint, test-modules]
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/v') || github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 缓存 pip 依赖
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-build-${{ hashFiles('**/requirements*.txt', 'setup_dependencies.py') }}
          restore-keys: |
            ${{ runner.os }}-pip-build-
            ${{ runner.os }}-pip-

      - name: 安装构建依赖
        run: |
          python -m pip install --upgrade pip
          pip install flet psutil pyserial requests colorama wmi pythonnet pynvml
          pip install pyinstaller>=5.13.0

      - name: 下载 LibreHardwareMonitor DLL
        run: |
          python setup_dependencies.py --build-only
        continue-on-error: true

      - name: 手动下载 LHM DLL (备用方案)
        if: failure()
        run: |
          # 如果自动下载失败，使用 curl 手动下载
          mkdir -p libs
          $release = Invoke-RestMethod -Uri "https://api.github.com/repos/LibreHardwareMonitor/LibreHardwareMonitor/releases/latest"
          $asset = $release.assets | Where-Object { $_.name -match "net4" -and $_.name -match ".zip" } | Select-Object -First 1
          if ($asset) {
            Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "lhm.zip"
            Expand-Archive -Path "lhm.zip" -DestinationPath "lhm_temp" -Force
            Get-ChildItem -Path "lhm_temp" -Recurse -Filter "LibreHardwareMonitorLib.dll" | Copy-Item -Destination "libs/" -Force
            Remove-Item -Path "lhm.zip" -Force
            Remove-Item -Path "lhm_temp" -Recurse -Force
          }
        shell: powershell

      - name: 验证资源文件
        run: |
          if (Test-Path "libs/LibreHardwareMonitorLib.dll") {
            Write-Host "✓ LibreHardwareMonitorLib.dll exists"
          } else {
            Write-Host "✗ LibreHardwareMonitorLib.dll missing"
            exit 1
          }
          
          if (Test-Path "assets/logo_484x74.png") {
            Write-Host "✓ Logo file exists"
          } else {
            Write-Host "⚠ Logo file missing (optional)"
          }
        shell: powershell

      - name: 构建可执行文件
        run: |
          python build.py

      - name: 验证构建产物
        run: |
          if (Test-Path "dist/SuperKeyHUB.exe") {
            $size = (Get-Item "dist/SuperKeyHUB.exe").Length / 1MB
            Write-Host "✓ SuperKeyHUB.exe built successfully ($([math]::Round($size, 1)) MB)"
          } else {
            Write-Host "✗ Build failed - exe not found"
            exit 1
          }
        shell: powershell

      - name: 上传构建产物
        uses: actions/upload-artifact@v4
        with:
          name: SuperKeyHUB-Windows-x64
          path: dist/SuperKeyHUB.exe
          retention-days: 30

  # ============================================
  # 创建 Release (仅在 tag 推送时)
  # ============================================
  release:
    name: 发布 Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 下载构建产物
        uses: actions/download-artifact@v4
        with:
          name: SuperKeyHUB-Windows-x64
          path: release/

      - name: 获取版本号
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: 创建 Release
        uses: softprops/action-gh-release@v2
        with:
          name: SuperKeyHUB ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## SuperKeyHUB ${{ steps.get_version.outputs.VERSION }}
            
            ### 下载
            - `SuperKeyHUB.exe` - Windows 可执行文件
            
            ### 使用说明
            1. 将 SuperKey 通过 USB 连接到电脑
            2. 运行 SuperKeyHUB.exe
            3. 在串口配置页面选择正确的串口号
            4. 配置波特率为 1000000
            5. 点击连接，然后点击数据下发按钮
            
            ### 系统要求
            - Windows 10/11
            - .NET Framework 4.7.2+
            
            ### 注意事项
            - 首次运行可能需要管理员权限（硬件监控功能）
          files: |
            release/SuperKeyHUB.exe
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
